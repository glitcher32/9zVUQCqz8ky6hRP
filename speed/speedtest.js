function Speedtest(){this._serverList=[],this._selectedServer=null,this._settings={},this._state=0,console.log("LibreSpeed by Federico Dossena v5.1 - https://github.com/librespeed/speedtest")}Speedtest.prototype={constructor:Speedtest,getState:function(){return this._state},setParameter:function(e,t){if(0!=this._state)throw"You cannot change the test settings after adding server or starting the test";this._settings[e]=t,"temeletry_extra"===e&&(this._originalExtra=this._settings.telemetry_extra)},_checkServerDefinition:function(e){try{if("string"!=typeof e.name)throw"Name string missing from server definition (name)";if("string"!=typeof e.server)throw"Server address string missing from server definition (server)";if("/"!=e.server.charAt(e.server.length-1)&&(e.server+="/"),0==e.server.indexOf("//")&&(e.server=location.protocol+e.server),"string"!=typeof e.dlURL)throw"Download URL string missing from server definition (dlURL)";if("string"!=typeof e.ulURL)throw"Upload URL string missing from server definition (ulURL)";if("string"!=typeof e.pingURL)throw"Ping URL string missing from server definition (pingURL)";if("string"!=typeof e.getIpURL)throw"GetIP URL string missing from server definition (getIpURL)"}catch(e){throw"Invalid server definition"}},addTestPoint:function(e){if(this._checkServerDefinition(e),0==this._state&&(this._state=1),1!=this._state)throw"You can't add a server after server selection";this._settings.mpot=!0,this._serverList.push(e)},addTestPoints:function(e){for(var t=0;t<e.length;t++)this.addTestPoint(e[t])},getSelectedServer:function(){if(this._state<2||null==this._selectedServer)throw"No server is selected";return this._selectedServer},setSelectedServer:function(e){if(this._checkServerDefinition(e),3==this._state)throw"You can't select a server while the test is running";this._selectedServer=e,this._state=2},selectServer:function(t){if(1!=this._state){if(0==this._state)throw"No test points added";if(2==this._state)throw"Server already selected";if(3<=this._state)throw"You can't select a server while the test is running"}if(this._selectServerCalled)throw"selectServer already called";this._selectServerCalled=!0;for(var e=function(s,r){var e=!0;/MSIE.(\d+\.\d+)/i.test(navigator.userAgent)&&(e=!1);var i=function(r,i){r+=(r.match(/\?/)?"&":"?")+"cors=true";var n=new XMLHttpRequest,o=(new Date).getTime();if(n.onload=function(){if(0==n.responseText.length){var e=(new Date).getTime()-o;try{var t=performance.getEntriesByName(r),s=(t=t[t.length-1]).responseStart-t.requestStart;s<=0&&(s=t.duration),0<s&&s<e&&(e=s)}catch(e){}i(e)}else i(-1)}.bind(this),n.onerror=function(){i(-1)}.bind(this),n.open("GET",r),e)try{n.timeout=2e3,n.ontimeout=n.onerror}catch(e){}n.send()}.bind(this),t=function(t,s){var e=0;if((t.pingT=-1)==t.server.indexOf(location.protocol))s();else{var r=function(){3!=e++?i(t.server+t.pingURL,function(e){0<=e?((e<t.pingT||-1==t.pingT)&&(t.pingT=e),(e<500?r:s)()):s()}.bind(this)):s()}.bind(this);r()}}.bind(this),n=0,o=function(){for(var e=null,t=0;t<s.length;t++)-1!=s[t].pingT&&(null==e||s[t].pingT<e.pingT)&&(e=s[t]);r(e)}.bind(this),a=function(){n!=s.length?t(s[n++],a):o()}.bind(this);a()}.bind(this),s=[],r=0;r<6;r++)s[r]=[];for(r=0;r<this._serverList.length;r++)s[r%6].push(this._serverList[r]);var i=0,n=null;for(r=0;r<6;r++)e(s[r],function(e){null!=e&&(null==n||e.pingT<n.pingT)&&(n=e),6==++i&&(this._selectedServer=n,this._state=2,t&&t(n))}.bind(this))},start:function(){if(3==this._state)throw"Test already running";if(this.worker=new Worker("speedtest_worker.js?r="+Math.random()),this.worker.onmessage=function(e){if(e.data!==this._prevData){this._prevData=e.data;var t=JSON.parse(e.data);try{this.onupdate&&this.onupdate(t)}catch(e){console.error("Speedtest onupdate event threw exception: "+e)}if(4<=t.testState){try{this.onend&&this.onend(5==t.testState)}catch(e){console.error("Speedtest onend event threw exception: "+e)}clearInterval(this.updater),this._state=4}}}.bind(this),this.updater=setInterval(function(){this.worker.postMessage("status")}.bind(this),200),1==this._state)throw"When using multiple points of test, you must call selectServer before starting the test";2==this._state&&(this._settings.url_dl=this._selectedServer.server+this._selectedServer.dlURL,this._settings.url_ul=this._selectedServer.server+this._selectedServer.ulURL,this._settings.url_ping=this._selectedServer.server+this._selectedServer.pingURL,this._settings.url_getIp=this._selectedServer.server+this._selectedServer.getIpURL,void 0!==this._originalExtra?this._settings.telemetry_extra=JSON.stringify({server:this._selectedServer.name,extra:this._originalExtra}):this._settings.telemetry_extra=JSON.stringify({server:this._selectedServer.name})),this._state=3,this.worker.postMessage("start "+JSON.stringify(this._settings))},abort:function(){if(this._state<3)throw"You cannot abort a test that's not started yet";this._state<4&&this.worker.postMessage("abort")}};